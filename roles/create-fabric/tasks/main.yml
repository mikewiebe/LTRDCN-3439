---
# tasks file for /home/cisco/Documents/ndfclab/ansible/roles/create-fabric


- ansible.builtin.debug:
    msg:
      - "----------------------------------------------------------------"
      - "+             Calling Role - [create-fabric]                   +"
      - "----------------------------------------------------------------"

- name: Get Fabric List
  cisco.dcnm.dcnm_rest:
    method: GET
    path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics"
  register: result

- ansible.builtin.set_fact:
    create_fabric: True

# ADD Later in Lab
- ansible.builtin.set_fact:
    create_fabric_ext: True

- ansible.builtin.set_fact:
    create_fabric: False
  when: item.fabricName == fabric.name
  loop: "{{ result.response.DATA }}"
  loop_control:
    label: "{{ item.fabricName }}"

# ADD Later in Lab
- ansible.builtin.set_fact:
    create_fabric_ext: False
  when: item.fabricName == fabric_external.name
  loop: "{{ result.response.DATA }}"
  loop_control:
    label: "{{ item.fabricName }}"

- ansible.builtin.debug:
    msg: "Fabric {{ fabric.name}} Already Exists"
  when: not create_fabric

# ADD Later in Lab
- ansible.builtin.debug:
    msg: "Fabric {{ fabric_external.name }} Already Exists"
  when: not create_fabric_ext

- name: Create Fabric {{ fabric.name }} on NDFC
  vars:
    payload:
        BGP_AS: "{{ fabric.asn }}"
        GRFIELD_DEBUG_FLAG: "Enable"
        OVERLAY_MODE: "cli"
        VRF_LITE_AUTOCONFIG: "ToExternalOnly"
        DCI_SUBNET_RANGE: "10.31.0.0/16"
        AUTO_SYMMETRIC_VRF_LITE: true
  cisco.dcnm.dcnm_rest:
    method: POST
    path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ fabric.name }}/Easy_Fabric"
    json_data: "{{ payload| to_json }}"
  when: create_fabric

# ADD Later in Lab
- name: Create External Fabric on NDFC
  vars:
    payload:
        BGP_AS: "{{ fabric_external.asn }}"
        IS_READ_ONLY: false
  cisco.dcnm.dcnm_rest:
    method: POST
    path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ fabric_external.name }}/External_Fabric"
    json_data: "{{ payload| to_json }}"
  when: create_fabric_ext

# Add later in lab for POAP
- name: Enable POAP For {{ fabric.name }} on NDFC
  vars:
    payload:
        BOOTSTRAP_ENABLE: true
        DHCP_ENABLE: true
        DHCP_IPV6_ENABLE: "DHCPv4"
        DHCP_START: "10.15.27.14"
        DHCP_END: "10.15.27.14"
        MGMT_GW: "10.15.27.1"
        MGMT_PREFIX: "24"
  cisco.dcnm.dcnm_rest:
    method: PUT
    path: "/appcenter/cisco/ndfc/api/v1/lan-fabric/rest/control/fabrics/{{ fabric.name }}/Easy_Fabric"
    json_data: "{{ payload| to_json }}"
